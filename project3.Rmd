---
title: 'TMA4315: Project 3'
author: "jototlan@stud.ntnu.no (10018), martigtu@stud.ntnu.no (10037)"
output:
  pdf_document: default
  html_document:
    df_print: paged
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

Load data:
```{r}
long <- read.csv("https://www.math.ntnu.no/emner/TMA4315/2020h/eliteserie.csv", colClasses = c("factor","factor","factor","numeric"))
head(long)
```
# a)
We consider the model
```{r}
library(glmmTMB)
mod <- glmmTMB(goals ~ home + (1|attack) + (1|defence),  poisson, data=long, REML=TRUE)
```

The distributional assumption on the $i$'th response (number of goals) is $y_{i}|\gamma_{j(i)},\gamma_{k(i)} \sim \mathrm{Poisson}(\lambda_{i})$, $i = 1, 2, \ldots, n = 480$. The conditional mean is connected to the covariates by the canonical link function:

$$
\lambda_i = \exp\left(\beta_0 + \beta_h x_{i} + \gamma_{j(i)}^a + \gamma_{k(i)}^{d} \right).
$$

Here, $\beta_h$ is the effect of playing home,  $\gamma_{j(i)}^a$ is the effect of team $j(i)$ attacking, $\gamma_{k(i)}^d$ is the effect of team $k(i)$ defending, and $\varepsilon_{i}$ is the error term. The random effects are independent and identically distributed, such that

$$
\gamma_{j(i)}^a \sim \mathcal{N}(0, \tau_{\text{a}}) \quad \text{and} \quad \gamma_{k(i)}^d \sim \mathcal{N}(0, \tau_{d}),
$$
where $j(i) = 1, 2, \ldots, m,\, k(i) = 1, 2, \ldots, m = 16$ 

## Distributional Assumption on Response

Assuming that the response follows a Poisson distribution amounts to making the following assumptions: 
\begin{enumerate}
\item Goals are scored independently, i.e. the number of goals scored within disjoint time intervals is independent.
\item The number of goals scored in a time interval is proportional to the length of the interval.
\item Two (or more) goals cannot be scored at exactly the same instance.
\end{enumerate}

The last two assumptions seem very reasonable; two goals can obviously not occur at the same time, and more time gives more oppurtunities for goal scoring. The first one, however, is more questionable. For example, a team might which has just conceded a goal close to the end of the game might play more aggressively to salvage a draw, hence increasing the likelihood of more goals being scored. Despite this, the Poisson distribution seems like a reasonable choice to model this process. \textcolor{red}{Trenger flere antagelser? Diskutere REML?}


# b)

```{r}
summary(mod)
ranef(mod)
```

The effect of playing home is positive and statistically significant. According to the output, it almost worth half a goal (0.40716). This seems reasonable from an intuitive perspective. Looking at the estimated random effects, we can e.g. consider $\gamma_\text{Rosenborg}^{\text{defence}} \approx -0.153$. This is the lowest value among all teams, which indicates that Rosenborg is the best defending team. To check this, we calculate the average number of goals conceded by every team:
```{r}
no.NA = long[is.na(long$goals) == 0, c("defence", "goals")]
agg = aggregate(no.NA$goals, by = list(no.NA$defence), FUN = mean)
colnames(agg) <- c("Team", "Avg. # of conceded goals")
knitr::kable(agg)
```
As expected, Rosenborg has the lowest average number of conceded goals.

we denote the team of average attack strength by $A$, and the team of average defense strength by $D$. Let $y_A$ be the number of goals scored by team $A$, and similarly $y_D$ be the number of goals scored by team $D$ Then, we want to estimate \textcolor{red}{skal epsilon vÃ¦re med egt?}

$$
\mathrm{E}\left[ y_A \right] = \exp\left(\beta_h + \gamma_{A}^\text{attack} + \gamma_{D}^{\text{defence}} + \varepsilon_{i}\right),
$$

as well as

$$
\mathrm{Var}(y_A)
$$
\textcolor{red}{mangler informasjon for yB?}



## Marginal variance and intraclass covariance probit model via pmvnorm

```{r}
#install.packages("mvtnorm")
library(mvtnorm) # to use pmvnorm()
```

## Power of correct mixed vs misspecified fixed effect model vs pseudoreplication

## Numerical computation of the critical value for LRT test of random slope



